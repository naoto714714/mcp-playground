name: Issue to PR

on:
  issues:
    types: [opened]

env:
  AWS_REGION: ap-northeast-1
  ROLE_ARN: arn:aws:iam::886789338663:role/github-actions-claude-code
  ROLE_SESSION_NAME: github-actions-${{ github.run_id }}

jobs:
  implement:
    if: (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: ${{ env.ROLE_SESSION_NAME }}

      - uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            Analyze this new issue and:
            1. Determine if it's a bug report, feature request, or question
            2. Assess priority (critical, high, medium, low)
            3. Suggest appropriate labels
            4. Check if it duplicates existing issues

            Based on your analysis, add the appropriate labels using:
            `gh issue edit [number] --add-label "label1,label2"`

            If it appears to be a duplicate, post a comment mentioning the original issue.
          claude_args: |
            --model jp.anthropic.claude-haiku-4-5-20251001-v1:0
            --allowedTools Bash(gh issue:*)
